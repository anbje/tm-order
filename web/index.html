<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TM-Order - Translation Management</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 24px;
        }
        h1 {
            color: #2c3e50;
            margin-bottom: 24px;
            border-bottom: 2px solid #3498db;
            padding-bottom: 12px;
        }
        .btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin-bottom: 20px;
        }
        .btn:hover { background: #2980b9; }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background: #ecf0f1;
            font-weight: 600;
            color: #2c3e50;
        }
        tr:hover { background: #f9f9f9; }
        .status {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        .status-pending { background: #fff3cd; color: #856404; }
        .status-in-progress { background: #d1ecf1; color: #0c5460; }
        .status-delivered { background: #d4edda; color: #155724; }
        .deadline-soon { color: #e74c3c; font-weight: 600; }
        .edit-btn {
            background: #f39c12;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        .edit-btn:hover { background: #e67e22; }
        #orders-list { margin-top: 20px; }
        .loading { text-align: center; padding: 40px; color: #7f8c8d; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìã TM-Order - Translation Management</h1>
        <button class="btn" onclick="window.location.reload()">üîÑ Refresh</button>
        <form id="order-form" style="margin-bottom:24px;display:flex;flex-wrap:wrap;gap:12px;align-items:flex-end;">
            <input type="text" id="customer_name" placeholder="Customer" required style="flex:1;min-width:120px;">
            <input type="text" id="topic" placeholder="Topic" style="flex:1;min-width:120px;">
            <input type="datetime-local" id="deadline_at" required style="min-width:180px;">
            <input type="text" id="source_lang" placeholder="Source Lang" required style="width:80px;">
            <input type="text" id="target_lang" placeholder="Target Lang" required style="width:80px;">
            <input type="number" id="word_count" placeholder="Words" min="0" style="width:80px;">
            <button type="submit" class="btn">‚ûï Add Order</button>
        </form>
        
        <!-- Settings Panel -->
        <div id="settings-panel" style="margin-bottom:24px;padding:20px;border:1px solid #ddd;border-radius:8px;background:#f9f9f9;">
            <h2 style="margin-bottom:16px;color:#2c3e50;">‚öôÔ∏è Settings</h2>
            <form id="settings-form" style="display:flex;flex-wrap:wrap;gap:16px;align-items:flex-end;">
                <div style="display:flex; align-items:center; gap:8px;">
                    <input type="checkbox" id="reminders_enabled" style="width:auto;">
                    <label for="reminders_enabled">Enable Deadline Reminders</label>
                </div>
                <div>
                    <label for="reminder_24h" style="display:block;margin-bottom:4px;">24h Reminder (hours before):</label>
                    <input type="number" id="reminder_24h" min="1" max="168" value="24" style="width:80px;">
                </div>
                <div>
                    <label for="reminder_6h" style="display:block;margin-bottom:4px;">6h Reminder (hours before):</label>
                    <input type="number" id="reminder_6h" min="1" max="48" value="6" style="width:80px;">
                </div>
                <div>
                    <label for="reminder_2h" style="display:block;margin-bottom:4px;">2h Reminder (hours before):</label>
                    <input type="number" id="reminder_2h" min="1" max="24" value="2" style="width:80px;">
                </div>
                <button type="submit" class="btn" style="background:#27ae60;">üíæ Save Settings</button>
            </form>
            <div id="settings-status" style="margin-top:12px;font-weight:600;"></div>
        </div>
        
        <div id="orders-list" class="loading">Loading orders...</div>
        
        <!-- Edit Order Modal -->
        <div id="edit-modal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;">
            <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:white;padding:24px;border-radius:8px;min-width:400px;">
                <h3>Edit Order #<span id="edit-order-id"></span></h3>
                <form id="edit-form" style="display:flex;flex-direction:column;gap:12px;margin-top:16px;">
                    <div>
                        <label>Customer:</label>
                        <input type="text" id="edit-customer" required>
                    </div>
                    <div>
                        <label>Topic:</label>
                        <input type="text" id="edit-topic">
                    </div>
                    <div>
                        <label>Deadline (Stockholm time):</label>
                        <input type="datetime-local" id="edit-deadline" required>
                    </div>
                    <div>
                        <label>Status:</label>
                        <select id="edit-status" required>
                            <option value="pending">Pending</option>
                            <option value="delivered">Delivered</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                    </div>
                    <div style="display:flex;gap:12px;justify-content:flex-end;margin-top:16px;">
                        <button type="button" onclick="closeEditModal()" style="background:#95a5a6;color:white;border:none;padding:8px 16px;border-radius:4px;">Cancel</button>
                        <button type="submit" class="btn" style="background:#27ae60;">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        document.getElementById('order-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const data = {
                customer_name: document.getElementById('customer_name').value,
                topic: document.getElementById('topic').value,
                deadline_at: document.getElementById('deadline_at').value,
                source_lang: document.getElementById('source_lang').value,
                target_lang: document.getElementById('target_lang').value,
                word_count: parseInt(document.getElementById('word_count').value) || 0
            };
            try {
                const resp = await fetch(`${API_URL}/api/orders`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (!resp.ok) throw new Error('Failed to create order');
                document.getElementById('order-form').reset();
                loadOrders();
            } catch (err) {
                alert('Error creating order: ' + err);
            }
        });
        // Primary API endpoint for production (Caddy provides TLS)
        // Default to the public domain. This variable is mutable so we can override it
        // at runtime when serving the web UI locally for development/testing.
        let API_URL = 'https://tmorder.duckdns.org';

        // For local development prefer a local origin (e.g. http://localhost:8001).
        // If the page is served from localhost, use that origin as API URL so fetch calls
        // work without touching this file repeatedly.
        try {
            const hostname = window.location && window.location.hostname;
            const origin = window.location && window.location.origin;
            if (hostname && (hostname === 'localhost' || hostname === '127.0.0.1')) {
                if (origin) {
                    console.info('Detected local dev host, using local API origin:', origin);
                    API_URL = origin; // override for local testing
                }
            }
        } catch (e) {
            // ignore in non-browser environments
        }

        // Load settings on page load
        loadSettings();

        async function loadSettings() {
            try {
                const response = await fetch(`${API_URL}/api/settings`);
                const settings = await response.json();
                
                // Populate settings form
                const reminders = settings.deadline_reminders || {};
                document.getElementById('reminders_enabled').checked = reminders.enabled !== false;
                document.getElementById('reminder_24h').value = reminders.reminder_24h || 24;
                document.getElementById('reminder_6h').value = reminders.reminder_6h || 6;
                document.getElementById('reminder_2h').value = reminders.reminder_2h || 2;
                
                document.getElementById('settings-status').textContent = 'Settings loaded successfully';
                document.getElementById('settings-status').style.color = '#27ae60';
                setTimeout(() => document.getElementById('settings-status').textContent = '', 3000);
            } catch (error) {
                console.error('Error loading settings:', error);
                document.getElementById('settings-status').textContent = 'Error loading settings';
                document.getElementById('settings-status').style.color = '#e74c3c';
            }
        }

        // Handle settings form submission
        document.getElementById('settings-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const data = {
                deadline_reminders: {
                    enabled: document.getElementById('reminders_enabled').checked,
                    reminder_24h: parseInt(document.getElementById('reminder_24h').value),
                    reminder_6h: parseInt(document.getElementById('reminder_6h').value),
                    reminder_2h: parseInt(document.getElementById('reminder_2h').value)
                }
            };
            
            try {
                const resp = await fetch(`${API_URL}/api/settings`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                if (!resp.ok) {
                    const errorData = await resp.json();
                    throw new Error(errorData.detail || 'Failed to save settings');
                }
                
                document.getElementById('settings-status').textContent = 'Settings saved successfully!';
                document.getElementById('settings-status').style.color = '#27ae60';
                setTimeout(() => document.getElementById('settings-status').textContent = '', 3000);
                
            } catch (err) {
                console.error('Error saving settings:', err);
                document.getElementById('settings-status').textContent = 'Error saving settings: ' + err.message;
                document.getElementById('settings-status').style.color = '#e74c3c';
            }
        });

        async function loadOrders() {
            try {
                const response = await fetch(`${API_URL}/api/orders`);
                const orders = await response.json();
                displayOrders(orders);
            } catch (error) {
                document.getElementById('orders-list').innerHTML = 
                    '<p style="color: red;">Error loading orders. Check API connection.</p>';
                console.error('Error:', error);
            }
        }

        function displayOrders(orders) {
            console.log('Orders received:', orders);
            if (orders.length === 0) {
                document.getElementById('orders-list').innerHTML = 
                    '<p>No orders yet. Create your first order via Telegram!</p>';
                return;
            }

            const now = new Date();
            const html = `
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Customer</th>
                            <th>Languages</th>
                            <th>Words</th>
                            <th>Topic</th>
                            <th>Deadline</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${orders.map(order => {
                            const deadline = new Date(order.deadline_at);
                            const hoursUntil = (deadline - now) / (1000 * 60 * 60);
                            const deadlineClass = hoursUntil < 24 && hoursUntil > 0 ? 'deadline-soon' : '';
                            
                            return `
                                <tr>
                                    <td><strong>#${order.id}</strong></td>
                                    <td>${order.customer_name}</td>
                                    <td>${order.source_lang} ‚Üí ${order.target_lang}</td>
                                    <td>${order.word_count || '‚Äî'}</td>
                                    <td>${order.topic || '‚Äî'}</td>
                                    <td class="${deadlineClass}">${deadline.toLocaleString()}</td>
                                    <td><span class="status status-${order.status}">${order.status}</span></td>
                                    <td><button class="edit-btn" onclick="editOrder(${order.id})">Edit</button></td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
            
            console.log('Generated HTML:', html);
            const element = document.getElementById('orders-list');
            console.log('Element found:', element);
            element.innerHTML = html;
        }

        // Load orders on page load
        loadOrders();
        
        // Refresh every 30 seconds
        setInterval(loadOrders, 30000);

        // Global variable to store current order being edited
        let currentEditingOrder = null;

        function editOrder(orderId) {
            // Find the order data
            loadOrders().then(() => {
                fetch(`${API_URL}/api/orders`)
                    .then(response => response.json())
                    .then(orders => {
                        const order = orders.find(o => o.id === orderId);
                        if (!order) {
                            alert('Order not found');
                            return;
                        }
                        
                        currentEditingOrder = order;
                        
                        // Populate modal
                        document.getElementById('edit-order-id').textContent = order.id;
                        document.getElementById('edit-customer').value = order.customer_name;
                        document.getElementById('edit-topic').value = order.topic || '';
                        document.getElementById('edit-status').value = order.status;
                        
                        // Convert UTC deadline to Stockholm local time for display
                        const deadlineUTC = new Date(order.deadline_at);
                        // Stockholm is UTC+1 (standard) or UTC+2 (DST)
                        // For simplicity, assume UTC+1 for now (can be improved with proper timezone library)
                        const stockholmOffset = 60; // minutes
                        const deadlineStockholm = new Date(deadlineUTC.getTime() + (stockholmOffset * 60 * 1000));
                        const localDatetime = deadlineStockholm.toISOString().slice(0, 16);
                        document.getElementById('edit-deadline').value = localDatetime;
                        
                        // Show modal
                        document.getElementById('edit-modal').style.display = 'block';
                    })
                    .catch(error => {
                        console.error('Error loading order for edit:', error);
                        alert('Error loading order data');
                    });
            });
        }

        function closeEditModal() {
            document.getElementById('edit-modal').style.display = 'none';
            currentEditingOrder = null;
        }

        // Handle edit form submission
        document.getElementById('edit-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!currentEditingOrder) {
                alert('No order selected for editing');
                return;
            }
            
            // Show confirmation
            if (!confirm(`Are you sure you want to update Order #${currentEditingOrder.id}?`)) {
                return;
            }
            
            const data = {
                customer_name: document.getElementById('edit-customer').value,
                topic: document.getElementById('edit-topic').value,
                status: document.getElementById('edit-status').value
            };
            
            // Convert Stockholm local time to UTC for storage
            const stockholmDatetime = document.getElementById('edit-deadline').value;
            if (stockholmDatetime) {
                const stockholmDate = new Date(stockholmDatetime);
                // Convert from Stockholm time (assume UTC+1) back to UTC
                const stockholmOffset = 60; // minutes
                const utcDate = new Date(stockholmDate.getTime() - (stockholmOffset * 60 * 1000));
                data.deadline_at = utcDate.toISOString();
            }
            
            try {
                const resp = await fetch(`${API_URL}/api/orders/${currentEditingOrder.id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                if (!resp.ok) {
                    const errorData = await resp.json();
                    throw new Error(errorData.detail || 'Failed to update order');
                }
                
                alert('Order updated successfully!');
                closeEditModal();
                loadOrders(); // Refresh the table
                
            } catch (err) {
                console.error('Error updating order:', err);
                alert('Error updating order: ' + err.message);
            }
        });
    </script>
</body>
</html>
